
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Woodworking Toolkit - All-in-One</title>
  
  <!-- Consolidated Styles from styles.css -->
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      text-align: center;
      display: flex;
      flex-direction: column;
    }
    .site {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
    }
    .site-content {
      flex: 1;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
    /* Header */
    .site-header {
      background-color: #2c3e50;
      color: #ecf0f1;
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .site-header h1 {
      margin: 0;
      font-size: 1.5rem;
    }
    .login-btn {
      background-color: #27ae60;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    .login-btn:hover {
      background-color: #2ecc71;
    }
    /* Hero Section */
    .hero {
      background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://placehold.co/1200x400/2c3e50/ffffff?text=Woodworking+Workshop') no-repeat center center;
      background-size: cover;
      color: white;
      padding: 60px 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    .hero-content h1 {
      font-size: 3rem;
      margin-bottom: 10px;
    }
    .lead {
      font-size: 1.2rem;
      opacity: 0.9;
    }
    /* Cards (Main Navigation) */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 25px;
      text-align: left;
      text-decoration: none;
      color: #333;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .card h2 {
      font-size: 1.5rem;
      color: #2c3e50;
      margin-top: 0;
    }
    .card p {
      font-size: 1rem;
      line-height: 1.5;
      color: #7f8c8d;
    }
    /* Footer */
    .site-footer {
      background-color: #333;
      color: #bdc3c7;
      padding: 20px;
      margin-top: 40px;
    }
    .social-links a {
      color: #bdc3c7;
      text-decoration: none;
      margin: 0 10px;
      font-size: 1.5rem;
      transition: color 0.2s;
    }
    .social-links a:hover {
      color: #ecf0f1;
    }
    /* Tool Page Specific Styles (Forms and Results) */
    .back-link {
      display: block;
      margin-bottom: 20px;
      text-decoration: none;
      color: #2c3e50;
      font-weight: bold;
      text-align: left;
      font-size: 1rem;
    }
    .tool-header {
      text-align: center;
      margin-bottom: 30px;
    }
    .tool-header h2 {
      color: #2c3e50;
      font-size: 2rem;
      margin-bottom: 10px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      text-align: left;
    }
    .form-row {
      margin-bottom: 20px;
    }
    .label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #34495e;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 1rem;
    }
    .btn-primary {
      display: block;
      width: 100%;
      padding: 12px;
      background-color: #2980b9;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn-primary:hover {
      background-color: #3498db;
    }
    /* Status Boxes */
    .hidden {
      display: none !important;
    }
    .error-box, .success-box {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-weight: bold;
    }
    .error-box {
      background-color: #fdd;
      border: 1px solid #f00;
      color: #c00;
    }
    .success-box {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    /* Instructions and Lists */
    .instructions-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #ecf0f1;
    }
    .instructions-section h3, .instructions-section h4 {
      color: #2c3e50;
      font-size: 1.5rem;
      margin-bottom: 15px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
    }
    .instructions-section ol, .instructions-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .instructions-section li {
      background-color: #ecf0f1;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 5px solid #3498db;
      border-radius: 4px;
      line-height: 1.4;
      text-align: left;
    }
    .instructions-section li strong {
      color: #2c3e50;
      display: block;
      margin-bottom: 5px;
    }
    .instructions-section ol {
        list-style: decimal;
        padding-left: 20px;
    }
    .instructions-section ol li {
        background: none;
        border: none;
        border-left: none;
        padding: 10px 0;
        margin-bottom: 5px;
        line-height: 1.6;
    }
    .instructions-section ol li:before {
        content: counter(li) ". ";
        font-weight: bold;
        color: #2980b9;
        margin-right: 5px;
    }
    /* Loading Spinner */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 50px;
      margin: 30px 0;
    }
    .loading-spinner::after {
      content: "";
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Media Queries for Responsiveness */
    @media (max-width: 768px) {
      .site-header {
        padding: 15px 20px;
      }
      .hero-content h1 {
        font-size: 2.5rem;
      }
      .lead {
        font-size: 1rem;
      }
      .cards {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="site">
    <!-- Header remains constant across all views -->
    <header class="site-header">
      <h1 onclick="navigateTo('home')" style="cursor: pointer;">üî® Learn to Build Anything</h1>
      <div id="login-logout">
        <a href="#" id="loginBtn" class="login-btn">Login</a>
      </div>
    </header>

    <div class="site-content">
      <!-- Status Box for global messages -->
      <div id="statusBox" class="error-box hidden" style="text-align: left; margin-top: 20px;">
        <span id="statusText"></span>
      </div>

      <!-- VIEW 1: HOME PAGE (index.html content) -->
      <div id="homeView" class="view">
        <div class="hero">
          <div class="hero-content">
            <h1>Craft Your Legacy</h1>
            <p class="lead">From rustic furniture to essential tools, your woodworking journey begins here. Welcome to the workshop.</p>
          </div>
        </div>
        <main class="cards">
          <a class="card" href="#" onclick="navigateTo('configurator'); return false;">
            <h2>ü™ö Start a New Project</h2>
            <p>Define your project's type (shelf, stool, etc.), wood species, and dimensions to generate a unique project plan.</p>
          </a>
          <a class="card" href="#" id="viewMaterialsLink" onclick="return checkProject(event, 'materials')">
            <h2>üß∞ View Materials List</h2>
            <p>Access the detailed lumber, hardware, and tool list required for your last (or current) project.</p>
          </a>
          <a class="card" href="#" id="viewInstructionsLink" onclick="return checkProject(event, 'instructions')">
            <h2>üìã Get Instructions</h2>
            <p>Retrieve the comprehensive, step-by-step construction guide based on your exact project specifications.</p>
          </a>
        </main>
      </div>

      <!-- VIEW 2: PROJECT CONFIGURATOR (build-filter.html content) -->
      <div id="configuratorView" class="view hidden">
        <a href="#" onclick="navigateTo('home'); return false;" class="back-link">‚Üê Back</a>
        <div class="tool-header">
          <h2>ü™ö Start a New Project</h2>
          <p class="lead">Define your project to generate the materials list and instructions.</p>
        </div>
        <div class="container" style="margin-top:12px;">
          <form id="builderForm">
            <div class="form-row">
              <label class="label" for="projectType">Project Type</label>
              <select id="projectType" required>
                <option value="">Select project type</option>
                <option value="stool">Small Stool (e.g., 18in tall)</option>
                <option value="shelf">Floating Shelf (e.g., 36in wide)</option>
                <option value="workbench">Small Workbench</option>
              </select>
            </div>
            <div class="form-row">
              <label class="label" for="woodType">Wood Type</label>
              <select id="woodType" required>
                <option value="">Select a wood type</option>
                <option value="pine">Pine (Soft, economical)</option>
                <option value="oak">Oak (Hard, durable)</option>
                <option value="cedar">Cedar (Weather-resistant)</option>
              </select>
            </div>
            <div class="form-row">
              <label class="label" for="screwLength">Fastener Length (Inches)</label>
              <input type="number" id="screwLength" min="1" max="4" step="0.5" placeholder="e.g., 2.5" required>
            </div>
            <div class="form-row">
              <label class="label" for="height">Height (in inches)</label>
              <input type="number" id="height" min="1" placeholder="e.g., 18" required>
            </div>
            <div class="form-row">
              <label class="label" for="width">Width (in inches)</label>
              <input type="number" id="width" min="1" placeholder="e.g., 36" required>
            </div>
            <div class="form-row">
              <label class="label" for="depth">Depth (in inches)</label>
              <input type="number" id="depth" min="1" placeholder="e.g., 12" required>
            </div>
            <button type="submit" class="btn-primary">Save Project & Get Materials</button>
          </form>
        </div>
      </div>

      <!-- VIEW 3: MATERIALS LIST (materials.html content) -->
      <div id="materialsView" class="view hidden">
        <a href="#" onclick="navigateTo('home'); return false;" class="back-link">‚Üê Back to Home</a>
        <div class="tool-header">
          <h2>üß∞ Tools & Materials Generator</h2>
          <p class="lead">Materials and cut list for your custom project, powered by AI planning.</p>
        </div>
        <div class="container" style="margin-top:12px;">
          <h3 id="materialsProjectTitle">Loading Project Details...</h3>
          <div id="materialsLoading" class="loading-spinner"></div>
          <div id="materialsOutput" class="instructions-section hidden">
            <div id="materialsList">
              <h4>Materials & Cut List</h4>
              <ul id="materialsUl">
                <!-- Dynamic list generated by the API mock will be injected here -->
              </ul>
            </div>
            <div id="toolsList" style="margin-top: 20px;">
              <h4>Tools Required</h4>
              <ul id="toolsUl">
                <!-- Basic list of tools -->
              </ul>
            </div>
            <!-- FIX: Added ID and removed inline onclick for dynamic attachment in JS -->
            <button id="materialsToInstructionsBtn" class="btn-primary">Go to Instructions</button>
          </div>
        </div>
      </div>

      <!-- VIEW 4: INSTRUCTIONS (project-instructions.html content) -->
      <div id="instructionsView" class="view hidden">
        <a href="#" onclick="navigateTo('home'); return false;" class="back-link">‚Üê Back to Home</a>
        <div class="tool-header">
          <h2>üìã Project Instructions</h2>
          <p class="lead">Step-by-step construction guide for your custom build.</p>
        </div>
        <div class="container" style="margin-top:12px;">
          <h3 id="instructionsProjectTitle">Loading Project Details...</h3>
          <div id="instructionsLoading" class="loading-spinner"></div>
          <div id="instructionsResults" class="hidden">
            <div id="guideSection" class="instructions-section">
              <h3>üî® Construction Steps</h3>
              <ol id="guideSteps">
                <!-- Steps generated by API mock will be inserted here -->
              </ol>
            </div>
          </div>
          <!-- FIX: Added ID for consistent button handling in JS -->
          <button id="instructionsToHomeBtn" class="btn-primary">Start New Project</button>
        </div>
      </div>
    </div>

    <!-- Footer remains constant across all views -->
    <footer class="site-footer">
      <div class="social-links">
        <a href="https://twitter.com" aria-label="Twitter">üê¶</a>
        <a href="https://instagram.com" aria-label="Instagram">üì∏</a>
        <a href="https://youtube.com" aria-label="YouTube">‚ñ∂Ô∏è</a>
      </div>
      <div style="margin-top: 10px;">
        <small>¬© 2024 Build Co. All rights reserved.</small>
      </div>
    </footer>
  </div>

  <script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    setLogLevel('Debug');

    // --- GLOBAL CONFIG & STATE ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
    const apiKey = ""; // API Key placeholder for LLM fetch

    let app, db, auth;
    let currentUserId = null;
    let latestProjectId = null;

    // --- DOM REFERENCES ---
    const views = {
      home: document.getElementById('homeView'),
      configurator: document.getElementById('configuratorView'),
      materials: document.getElementById('materialsView'),
      instructions: document.getElementById('instructionsView')
    };

    const loginBtn = document.getElementById('loginBtn');
    const statusBox = document.getElementById('statusBox');
    const statusText = document.getElementById('statusText');

    // --- UTILITY FUNCTIONS ---

    function showStatus(message, isError = false) {
      statusText.textContent = message;
      statusBox.className = isError ? 'error-box' : 'success-box';
      statusBox.classList.remove('hidden');
      setTimeout(() => statusBox.classList.add('hidden'), 5000);
    }

    /**
     * Attempts to fetch the last saved project ID for the current user.
     * Handles permission errors silently, as this often occurs when a user signs in for the first time.
     */
    async function getLatestProjectId(userId) {
      if (!db || !userId) return null;
      try {
        const docRef = doc(db, 'artifacts', appId, 'users', userId, 'config', 'latest');
        const docSnap = await getDoc(docRef);
        
        // Use optional chaining for safety
        if (docSnap.exists() && docSnap.data()?.latestProjectId) {
          return docSnap.data().latestProjectId;
        }
        return null; // Document is missing or data is malformed, return null silently.
      } catch(e) {
        // We catch the 'Missing or insufficient permissions' error, which happens when the config 
        // document doesn't exist for a new user, and treat it as a non-fatal event.
        if (e.code === 'permission-denied') {
            // Log as a warning to acknowledge the error but clearly mark it as non-fatal/expected for first-time users.
            console.warn("Expected FireStore Error: No 'latest' project ID found for new user.");
            return null;
        }
        console.error("Unexpected error fetching latest project ID:", e);
        return null;
      }
    }

    /**
     * Updates the project links on the home page based on whether a project exists.
     */
    function updateNavLinks(projectId) {
      const materialsLink = document.getElementById('viewMaterialsLink');
      const instructionsLink = document.getElementById('viewInstructionsLink');
      
      // The links rely on checkProject() if no ID exists, or navigateTo() if one does.
      if (projectId) {
        materialsLink.onclick = (e) => { e.preventDefault(); navigateTo('materials', projectId); return false; };
        instructionsLink.onclick = (e) => { e.preventDefault(); navigateTo('instructions', projectId); return false; };
      } else {
        // If no project ID, links will trigger the alert/status message via checkProject
        materialsLink.onclick = (e) => checkProject(e, 'materials');
        instructionsLink.onclick = (e) => checkProject(e, 'instructions');
      }
    }
    
    /**
     * Checks if a project exists before navigating to a detailed view.
     */
    window.checkProject = function(event, targetPage) {
        event.preventDefault();
        if (!latestProjectId) {
            showStatus('Please start a project in the configurator first!', true);
            return false;
        }
        navigateTo(targetPage, latestProjectId);
        return false;
    }

    // --- NAVIGATION AND RENDERING ---

    window.navigateTo = async function(page, projectId = null) {
      // Hide all views first
      Object.values(views).forEach(view => view.classList.add('hidden'));
      statusBox.classList.add('hidden'); // Clear status on navigation

      if (views[page]) {
        views[page].classList.remove('hidden');
        document.documentElement.scrollTop = 0; // Scroll to top

        // Call setup function for the target page
        if (page === 'home') {
          await setupHome();
        } else if (page === 'configurator') {
          setupConfigurator();
        } else if (page === 'materials' && projectId) {
          await setupMaterials(projectId);
        } else if (page === 'instructions' && projectId) {
          await setupInstructions(projectId);
        } else if ((page === 'materials' || page === 'instructions') && !projectId) {
           showStatus('Cannot navigate: No Project ID provided. Redirecting to home.', true);
           navigateTo('home');
        }
      } else {
        console.error('Invalid page requested:', page);
        navigateTo('home');
      }
    }

    // --- AUTHENTICATION HANDLERS ---

    async function handleLogin() {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Login failed:", error.code, error.message);
        showStatus('Login failed. See console for details.', true);
      }
    }

    async function handleLogout() {
      try {
        await signOut(auth);
        // After logout, onAuthStateChanged will handle UI update
      } catch (error) {
        console.error("Logout failed:", error.code, error.message);
        showStatus('Logout failed. See console for details.', true);
      }
    }

    // --- VIEW SPECIFIC LOGIC ---

    async function setupHome() {
      if (currentUserId) {
         latestProjectId = await getLatestProjectId(currentUserId);
         updateNavLinks(latestProjectId);
      }
    }

    function setupConfigurator() {
      const form = document.getElementById('builderForm');
      // Remove any previous listener before adding a new one to prevent duplicate submissions
      form.removeEventListener('submit', handleSubmit); 
      form.addEventListener('submit', handleSubmit);
    }
    
    /**
     * Handles form submission: saves project data and updates user's latest project ID.
     */
    async function handleSubmit(e) {
      e.preventDefault();
      
      const projectType = document.getElementById('projectType').value.trim();
      const woodType = document.getElementById('woodType').value.trim();
      const screwLength = document.getElementById('screwLength').value.trim();
      const height = document.getElementById('height').value.trim();
      const width = document.getElementById('width').value.trim();
      const depth = document.getElementById('depth').value.trim();

      if(!projectType || !woodType || !screwLength || !height || !width || !depth) {
          showStatus('Please fill out all required fields.', true);
          return;
      }

      if (!currentUserId) {
          showStatus('Authentication not ready. Please try again.', true);
          return;
      }

      const submitButton = e.target.querySelector('.btn-primary');
      submitButton.disabled = true;
      submitButton.textContent = 'Processing...';
      showStatus('Saving project...', false);

      const projectData = {
          projectType,
          woodType,
          screwLength: parseFloat(screwLength),
          height: parseFloat(height),
          width: parseFloat(width),
          depth: parseFloat(depth),
          userId: currentUserId,
          createdAt: new Date().toISOString()
      };

      try {
          // 1. Save the new project document to the user's private space
          const projectColRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'projects');
          const newProjectRef = await addDoc(projectColRef, projectData);
          const newProjectId = newProjectRef.id;
          latestProjectId = newProjectId; // Update global state

          // 2. Update the user's latest project ID in the config document
          const configDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'config', 'latest');
          await setDoc(configDocRef, { latestProjectId: newProjectId, updatedAt: new Date().toISOString() }, { merge: true });

          showStatus('Project saved successfully! Generating materials list...', false);
          
          // 3. Proceed to the materials view with the new project ID
          navigateTo('materials', newProjectId);

      } catch (error) {
          console.error("Error saving project:", error);
          showStatus('Failed to save project. Check console.', true);
      } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'Save Project & Get Materials';
      }
    }

    /**
     * Sets up the materials view by fetching project details and calling the LLM.
     */
    async function setupMaterials(projectId) {
      document.getElementById('materialsLoading').classList.remove('hidden');
      document.getElementById('materialsOutput').classList.add('hidden');
      document.getElementById('materialsProjectTitle').textContent = `Loading Project: ${projectId}...`;
      
      // Attach button listener
      document.getElementById('materialsToInstructionsBtn').onclick = (e) => { 
        e.preventDefault(); 
        navigateTo('instructions', projectId); 
        return false; 
      };

      try {
        const projectDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'projects', projectId);
        const projectSnap = await getDoc(projectDocRef);

        if (!projectSnap.exists()) {
          showStatus('Project not found.', true);
          navigateTo('home');
          return;
        }

        const data = projectSnap.data();
        
        document.getElementById('materialsProjectTitle').textContent = 
          `Project: ${data.projectType.toUpperCase()} (${data.width}x${data.height}x${data.depth} in)`;
        
        // --- LLM CALL to Generate Materials ---
        const userQuery = `Generate a detailed materials cut list and a short list of required tools for a ${data.projectType} that is ${data.width} inches wide, ${data.height} inches high, and ${data.depth} inches deep, using ${data.woodType} wood and ${data.screwLength} inch screws. Provide the output as a JSON object with two fields: 'materials' (an array of strings) and 'tools' (an array of strings).`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "materials": { 
                            "type": "ARRAY",
                            "description": "Detailed cut list and hardware.",
                            "items": { "type": "STRING" } 
                        },
                        "tools": { 
                            "type": "ARRAY",
                            "description": "Essential tools required.",
                            "items": { "type": "STRING" } 
                        }
                    },
                    "propertyOrdering": ["materials", "tools"]
                }
            }
        };

        const result = await callGeminiApi(payload);
        const { materials, tools } = result;

        // Display Results
        const materialsUl = document.getElementById('materialsUl');
        materialsUl.innerHTML = materials.map(item => `<li>${item}</li>`).join('');
        
        const toolsUl = document.getElementById('toolsUl');
        toolsUl.innerHTML = tools.map(item => `<li>${item}</li>`).join('');

        document.getElementById('materialsLoading').classList.add('hidden');
        document.getElementById('materialsOutput').classList.remove('hidden');

      } catch (error) {
        console.error("Error setting up materials:", error);
        showStatus('Failed to generate materials list. Check console.', true);
        document.getElementById('materialsLoading').classList.add('hidden');
      }
    }

    /**
     * Sets up the instructions view by fetching project details and calling the LLM.
     */
    async function setupInstructions(projectId) {
      document.getElementById('instructionsLoading').classList.remove('hidden');
      document.getElementById('instructionsResults').classList.add('hidden');
      document.getElementById('instructionsProjectTitle').textContent = `Loading Project: ${projectId}...`;

      // Attach button listener
      document.getElementById('instructionsToHomeBtn').onclick = (e) => { 
        e.preventDefault(); 
        navigateTo('home'); 
        return false; 
      };

      try {
        const projectDocRef = doc(db, 'artifacts', appId, 'users', currentUserId, 'projects', projectId);
        const projectSnap = await getDoc(projectDocRef);

        if (!projectSnap.exists()) {
          showStatus('Project not found.', true);
          navigateTo('home');
          return;
        }

        const data = projectSnap.data();
        
        document.getElementById('instructionsProjectTitle').textContent = 
          `Instructions: ${data.projectType.toUpperCase()} Build`;
        
        // --- LLM CALL to Generate Instructions ---
        const userQuery = `Generate detailed, step-by-step woodworking instructions for building a ${data.projectType} that is ${data.width} inches wide, ${data.height} inches high, and ${data.depth} inches deep, using ${data.woodType} wood and ${data.screwLength} inch screws. Focus on clear, safe construction steps. Provide the output as a JSON object with one field: 'steps' (an array of strings).`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: {
                    type: "OBJECT",
                    properties: {
                        "steps": { 
                            "type": "ARRAY",
                            "description": "Detailed construction steps.",
                            "items": { "type": "STRING" } 
                        }
                    },
                    "propertyOrdering": ["steps"]
                }
            }
        };

        const result = await callGeminiApi(payload);
        const { steps } = result;

        // Display Results
        const guideSteps = document.getElementById('guideSteps');
        guideSteps.innerHTML = steps.map(step => `<li>${step}</li>`).join('');

        document.getElementById('instructionsLoading').classList.add('hidden');
        document.getElementById('instructionsResults').classList.remove('hidden');

      } catch (error) {
        console.error("Error setting up instructions:", error);
        showStatus('Failed to generate instructions. Check console.', true);
        document.getElementById('instructionsLoading').classList.add('hidden');
      }
    }

    /**
     * Utility function for robust API calls with exponential backoff.
     */
    async function callGeminiApi(payload) {
      const model = "gemini-2.5-flash-preview-09-2025";
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
      const headers = { 'Content-Type': 'application/json' };

      for (let i = 0; i < 3; i++) { // Max 3 retries
        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
          }

          const result = await response.json();
          const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
          
          if (!jsonText) {
              throw new Error("Received empty content from API.");
          }
          
          try {
              return JSON.parse(jsonText);
          } catch (e) {
              // Handle malformed JSON response from the model
              throw new Error(`API returned invalid JSON: ${jsonText}`);
          }

        } catch (error) {
          if (i === 2) {
            console.error("Gemini API call failed after 3 attempts.", error);
            throw new Error("Failed to communicate with the AI builder service.");
          }
          const delay = Math.pow(2, i) * 1000;
          await new Promise(resolve => setTimeout(resolve, delay));
        }
      }
    }


    // --- INITIALIZATION ---
    function initializeFirebase() {
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Set up Auth State Listener
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            currentUserId = user.uid;
            loginBtn.textContent = 'Logout';
            loginBtn.onclick = handleLogout;
            // Now that user is authenticated, check for latest project and set up home view
            await navigateTo('home'); 
          } else {
            currentUserId = null;
            latestProjectId = null;
            loginBtn.textContent = 'Login';
            loginBtn.onclick = handleLogin;
            // Default to home, which will show links as inactive
            navigateTo('home');
          }
        });

        // Initial sign-in attempt
        handleLogin();

      } catch (error) {
        console.error("Firebase Initialization Error:", error);
        showStatus('Failed to initialize Firebase services.', true);
      }
    }

    // Start the application when the window loads
    window.onload = initializeFirebase;
  </script>
</body>
</html>